# ========================================
# Yamoyo - 로컬 HTTPS 환경 (프로덕션 동일 구조)
# ========================================
# 사용법:
# 1. infra/local/README.md 참고하여 초기 설정 (최초 1회)
# 2. docker-compose -f docker-compose.local.yml up -d
# 3. https://local.yamoyo.test 접속
# ========================================

services:
  # ========================================
  # Nginx (프론트 정적 파일 + 백엔드 프록시 + HTTPS)
  # ========================================
  nginx:
    image: nginx:alpine
    container_name: yamoyo-nginx-local
    restart: unless-stopped
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - ./infra/local/nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ./infra/local/certs:/etc/nginx/certs:ro
      - ./infra/local/frontend:/usr/share/nginx/html:ro
    depends_on:
      - backend
    networks:
      - yamoyo-local-network

  # ========================================
  # Backend (Spring Boot API)
  # ========================================
  backend:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: yamoyo-api-local
    restart: unless-stopped
    expose:
      - "8080"
    environment:
      SPRING_PROFILES_ACTIVE: local
      TZ: Asia/Seoul
    env_file:
      - .env.local
    depends_on:
      - redis
      - db
    networks:
      - yamoyo-local-network

  # ========================================
  # Redis (캐시 & 세션)
  # ========================================
  redis:
    image: redis:7-alpine
    container_name: yamoyo-redis-local
    restart: unless-stopped
    expose:
      - "6379"
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis-local-data:/data
    networks:
      - yamoyo-local-network

  # ========================================
  # MySQL (로컬 개발 DB - 프로덕션 격리)
  # ========================================
  db:
    image: mysql:8.0
    container_name: yamoyo-db-local
    restart: unless-stopped
    expose:
      - "3306"
    environment:
      MYSQL_ROOT_PASSWORD: local_root_password
      MYSQL_DATABASE: yamoyo_local
      MYSQL_USER: yamoyo_local
      MYSQL_PASSWORD: local_password
      TZ: Asia/Seoul
    volumes:
      - mysql-local-data:/var/lib/mysql
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
    networks:
      - yamoyo-local-network

# ========================================
# Volumes (로컬 전용 - 프로덕션과 분리)
# ========================================
volumes:
  redis-local-data:
    name: yamoyo-redis-local-data
  mysql-local-data:
    name: yamoyo-mysql-local-data

# ========================================
# Network
# ========================================
networks:
  yamoyo-local-network:
    name: yamoyo-local-network
    driver: bridge