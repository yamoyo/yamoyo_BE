# Spring Boot OAuth2 Application Configuration
# Role: OAuth2 클라이언트 설정 및 Nginx 프록시 환경 대응
# Complexity: Nginx를 통해 접근할 때 OAuth2 redirect URI가 올바르게 생성되도록 forwarded headers 전략 설정

spring:
  application:
    name: oauth2-template

  # JPA 설정
  jpa:
    hibernate:
      ddl-auto: validate  # Flyway가 스키마 관리, Hibernate는 검증만
    show-sql: true
    properties:
      hibernate:
        format_sql: true

  # Flyway 설정
  flyway:
    enabled: true
    baseline-on-migrate: true
    locations: classpath:db/migration

  # Database Configuration (MySQL)
  # 환경변수(DB_URL 등)가 있으면 그것을 사용(Docker), 없으면 기본값 사용(Local IDE)
  datasource:
    url: ${DB_URL:jdbc:mysql://localhost:3306/yamoyo?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=Asia/Seoul&characterEncoding=utf8}
    username: ${DB_USERNAME:yamoyo}
    password: ${DB_PASSWORD:yamoyo123}
    driver-class-name: com.mysql.cj.jdbc.Driver

  # Redis 설정
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}

  # OAuth2 Client Configuration
  # Role: Google, Kakao 등 여러 OAuth2 Provider 설정
  # Complexity: client-id와 client-secret은 환경변수로 주입받아 보안 강화
  security:
    oauth2:
      client:
        registration:
          # ===== Google OAuth2 Provider =====
          google:
            # Google Cloud Console에서 발급받은 Client ID
            # 환경변수: GOOGLE_CLIENT_ID (docker-compose.yml에서 주입)
            client-id: ${GOOGLE_CLIENT_ID}

            # Google Cloud Console에서 발급받은 Client Secret
            # 환경변수: GOOGLE_CLIENT_SECRET (docker-compose.yml에서 주입)
            client-secret: ${GOOGLE_CLIENT_SECRET}

            # OAuth2 scope (프로필 정보 및 이메일 접근 권한)
            scope:
              - profile
              - email

            # Redirect URI (Nginx 미사용 시 8080 포트 명시)
            # Nginx 도입 시: http://localhost/login/oauth2/code/google
            redirect-uri: http://localhost:8080/login/oauth2/code/google

          # ===== Kakao OAuth2 Provider =====
          # Kakao Developers Console: https://developers.kakao.com/
          kakao:
            # Kakao REST API 키
            # 환경변수: KAKAO_CLIENT_ID (선택사항)
            client-id: ${KAKAO_CLIENT_ID}

            # Kakao Client Secret (보안 강화 시 사용, 선택사항)
            # 환경변수: KAKAO_CLIENT_SECRET (선택사항)
            client-secret: ${KAKAO_CLIENT_SECRET}

            # Redirect URI (Nginx 미사용 시 8080 포트 명시)
            # Nginx 도입 시: http://localhost/login/oauth2/code/kakao
            redirect-uri: http://localhost:8080/login/oauth2/code/kakao

            # OAuth2 인가 방식
            authorization-grant-type: authorization_code

            # Kakao는 Client ID/Secret을 Body에 담아 보내는 방식을 사용해야 함 (기본값은 Basic Auth Header)
            client-authentication-method: client_secret_post

            # Kakao OAuth2 scope
            # profile_nickname: 닉네임 접근
            # account_email: 이메일 접근 (사용자 동의 필요)
            scope:
              - profile_nickname
              - profile_image
              - account_email

            # Provider 표시 이름
            client-name: Kakao

        # ===== Provider 설정 (Kakao는 수동 설정 필요) =====
        provider:
          kakao:
            # Kakao OAuth2 인가 엔드포인트
            authorization-uri: https://kauth.kakao.com/oauth/authorize

            # Kakao OAuth2 토큰 엔드포인트
            token-uri: https://kauth.kakao.com/oauth/token

            # Kakao 사용자 정보 엔드포인트
            user-info-uri: https://kapi.kakao.com/v2/user/me

            # 사용자 이름을 가져올 attribute key
            # Kakao는 "id" 필드를 사용자 식별자로 사용
            user-name-attribute: id


# Server Configuration
# Role: 내부 포트 설정 및 Nginx 프록시 헤더 인식 전략
# Complexity: Nginx가 전달한 X-Forwarded-* 헤더를 Spring이 인식하여
#             OAuth2 redirect URI를 http://localhost:80/login/oauth2/code/google 형태로 생성
server:
  port: 8080

  # Forwarded Headers Strategy
  # Role: Nginx가 전달한 X-Forwarded-Proto, X-Forwarded-Host 헤더를 신뢰하고 사용
  # Complexity:
  #   - 'framework': Spring Framework의 ForwardedHeaderFilter를 사용하여 헤더 처리
  #   - OAuth2 redirect URI 생성 시 클라이언트가 접근한 원본 주소(http://localhost:80)를 기준으로 생성
  #   - 이 설정이 없으면 Spring Boot는 내부 주소(http://spring-boot:8080)로 redirect URI를 생성하여 OAuth2 콜백 실패
  forward-headers-strategy: framework

# Logging (개발용, 프로덕션에서는 레벨 조정 필요)
logging:
  level:
    org.springframework.security: DEBUG
    org.springframework.security.oauth2: DEBUG

jwt:
  # JWT 시크릿 키 (Base64 인코딩). 환경변수 JWT_SECRET으로 주입받습니다.
  # 생성 예시: echo -n 'your-long-and-secure-secret-string' | base64
  secret-key: ${JWT_SECRET}
  access-token-expiration: 600000 # 10분
  refresh-token-expiration: 604800000 # 7일
  issuer: yamoyo-application

# OAuth2 로그인 성공 후 프론트엔드 리다이렉트 URL
# 프론트엔드 주소에 맞게 설정 (예: http://localhost:3000/oauth/callback)
oauth2:
  redirect-uri: ${OAUTH2_REDIRECT_URI:http://localhost:8080/oauth/callback}

cookie:
  secure: false

app:
  front:
    base-url: ${FRONT_BASE_URL:http://localhost:5173}
    paths:
      home: /home
      onboarding:
        terms: /onboarding/terms
        profile: /onboarding/profile

# Actuator 설정
management:
  endpoints:
    web:
      base-path: /api/actuator

# SpringDoc (Swagger/OpenAPI) 설정
springdoc:
  swagger-ui:
    tags-sorter: alpha
    operations-sorter: method
  packages-to-scan: com.yamoyo.be.domain
  paths-to-match: /api/**

firebase:
  key-path: ${FIREBASE_KEY_PATH:/app/config/firebase-adminsdk.json}